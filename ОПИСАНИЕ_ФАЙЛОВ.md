# ОПИСАНИЕ ФАЙЛОВ ПРОЕКТА

## Frontend файлы

### `index.html`
Главная страница веб-приложения. Содержит полную реализацию интерфейса с картой Яндекс.Карт, панелями управления, результатов и пользователя. Включает весь JavaScript код для работы с картой, построения маршрутов, анализа безопасности, авторизации и истории маршрутов. Стили CSS встроены в файл.

### `login.php`
Страница входа в систему. Содержит форму авторизации с полями логина и пароля, обработку отправки формы через JavaScript, отображение ошибок и ссылку на регистрацию. Также предоставляет возможность продолжить без авторизации.

### `register.php`
Страница регистрации нового пользователя. Содержит форму регистрации с полями логина и пароля, валидацию на клиенте, обработку отправки формы и отображение ошибок. После успешной регистрации перенаправляет на главную страницу.

---

## Backend API файлы (папка `api/`)

### `api/config.php`
Файл конфигурации системы. Определяет источник данных (база данных или файл), настройки подключения к БД, пути к файлам данных, параметры кэширования и другие системные настройки. Используется всеми API endpoints.

### `api/db.php`
Модуль подключения к базе данных MySQL. Содержит функцию `getDB()`, которая создает и возвращает PDO соединение с использованием паттерна singleton для предотвращения множественных подключений. Обрабатывает ошибки подключения.

### `api/data_loader.php`
Универсальный класс `DataLoader` для загрузки данных о ДТП из различных источников. Поддерживает работу с базой данных MySQL и NDJSON файлами. Реализует кэширование данных в памяти, фильтрацию по области и периоду, агрегацию данных для формирования опасных зон. Содержит оптимизированные методы для работы с большими объемами данных.

### `api/accidents.php`
API endpoint для получения данных о ДТП. Принимает параметры: `bbox` (границы области), `period` (период времени), `limit` (ограничение количества записей). Возвращает данные в формате GeoJSON. Использует `DataLoader` для загрузки данных из выбранного источника.

### `api/hotspots.php`
API endpoint для получения опасных зон (hotspots). Принимает параметры: `bbox` (границы области), `period` (период), `threshold` (минимальное количество ДТП для зоны), `grid` (размер ячейки сетки). Вычисляет опасные зоны на основе агрегации ДТП по сетке и возвращает их в формате GeoJSON с указанием уровня опасности.

### `api/auth.php`
API endpoint для авторизации пользователей. Обрабатывает регистрацию (`action=register`), вход в систему (`action=login`), выход (`action=logout`) и проверку статуса авторизации (`action=check`). Использует PHP сессии для управления состоянием пользователя, хэширует пароли через `password_hash()`.

### `api/route_history.php`
API endpoint для работы с историей маршрутов пользователей. Поддерживает получение истории (`GET` с параметром `limit`), добавление маршрута в историю (`POST`), удаление маршрута (`DELETE`). Автоматически ограничивает количество записей в истории до 5 последних для каждого пользователя.

### `api/cache_helper.php`
Вспомогательные функции для работы с файловым кэшем. Содержит функции `getCachedResponse()` для получения закэшированных данных и `saveCachedResponse()` для сохранения результатов запросов. Используется для оптимизации производительности API endpoints.

### `api/test_file.php`
Тестовый файл для отладки и проверки работы API. Может использоваться для тестирования подключения к базе данных, загрузки данных и других функций.

---

## База данных

### `schema.sql`
Основная схема базы данных MySQL. Создает таблицу `accidents` для хранения данных о ДТП с пространственным индексом, таблицу `grid_stats` для агрегированной статистики по сетке, и представление `accidents_recent` для быстрого доступа к недавним ДТП. Содержит все необходимые индексы для оптимизации запросов.

### `schema_v2.5.sql`
Дополнения к схеме базы данных для версии 2.5. Создает таблицы `users` для хранения пользователей системы и `route_history` для истории маршрутов. Включает внешние ключи и индексы для обеспечения целостности данных и быстрого доступа.

### `add_indexes.sql`
SQL скрипт для добавления дополнительных индексов к таблице `accidents`. Создает составной индекс `idx_lat_lon` на полях `lat` и `lon` для оптимизации запросов по координатам, что критично для производительности при работе с большими объемами данных.

---

## Скрипты импорта данных

### `import_ndjson.php`
Скрипт для импорта данных из NDJSON файла в базу данных MySQL. Читает файл построчно, парсит JSON записи, валидирует данные и вставляет их в таблицу `accidents` с использованием batch-вставок для оптимизации. Поддерживает параметры командной строки для указания файла и имени базы данных. Выводит прогресс импорта и статистику.

### `import_test.php`
Тестовый скрипт для проверки импорта данных. Используется для отладки процесса импорта на небольшом количестве записей перед полным импортом.

---

## Данные

### `moskva.ndjson`
Исходный файл с данными о ДТП в Москве в формате NDJSON (Newline Delimited JSON). Каждая строка файла представляет собой отдельную запись о ДТП в формате JSON. Файл содержит координаты, дату, категорию, тяжесть и другую информацию о происшествиях. Используется как альтернативный источник данных при работе без базы данных.

---

## Кэш (папка `cache/`)

### `cache/*.json`
Файлы кэша API ответов. Создаются автоматически при работе системы для хранения результатов запросов к API endpoints. Имя файла формируется как MD5 хэш параметров запроса. Используются для ускорения повторяющихся запросов и снижения нагрузки на базу данных.

---

## Документация

### `Курсовой проект.docx` / `Курсовой проект.pdf`
Документы курсового проекта (Word и PDF версии). Содержат полное описание проекта, включая пояснительную записку, техническое задание и другую документацию.

---

## Структура проекта

```
course_project2/
├── api/                    # Backend API
│   ├── config.php         # Конфигурация
│   ├── db.php             # Подключение к БД
│   ├── data_loader.php     # Загрузчик данных
│   ├── accidents.php      # API ДТП
│   ├── hotspots.php       # API опасных зон
│   ├── route_history.php  # API истории
│   ├── auth.php           # API авторизации
│   ├── cache_helper.php   # Утилиты кэша
│   └── test_file.php      # Тестовый файл
├── cache/                  # Кэш API
│   └── *.json             # Файлы кэша
├── index.html             # Главная страница
├── login.php              # Страница входа
├── register.php           # Страница регистрации
├── schema.sql             # Схема БД
├── schema_v2.5.sql        # Дополнения схемы
├── add_indexes.sql        # Дополнительные индексы
├── import_ndjson.php      # Импорт данных
├── import_test.php        # Тест импорта
└── moskva.ndjson          # Данные о ДТП
```

---

## Зависимости между файлами

**Frontend:**
- `index.html` → использует все API endpoints из папки `api/`
- `login.php`, `register.php` → используют `api/auth.php`

**Backend:**
- Все API файлы → используют `api/config.php` и `api/db.php`
- `api/accidents.php`, `api/hotspots.php` → используют `api/data_loader.php`
- `api/data_loader.php` → использует `api/db.php` и `api/config.php`
- `api/route_history.php`, `api/auth.php` → используют `api/db.php`
- `api/hotspots.php` → может использовать `api/cache_helper.php`

**База данных:**
- `schema.sql` → создает основную структуру БД
- `schema_v2.5.sql` → дополняет схему таблицами для авторизации
- `add_indexes.sql` → добавляет индексы для оптимизации
- `import_ndjson.php` → заполняет таблицу `accidents` из `moskva.ndjson`

