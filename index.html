<!doctype html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–ê–Ω–∞–ª–∏–∑ –î–¢–ü –≤ –ú–æ—Å–∫–≤–µ</title>

		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				height: 100vh;
				display: flex;
				background: #f5f5f5;
				overflow: hidden;
			}

			/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
			.sidebar {
				width: 320px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 2rem;
				display: flex;
				flex-direction: column;
				box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
				overflow-y: auto;
			}

			.sidebar h1 {
				font-size: 1.8rem;
				margin-bottom: 0.5rem;
				font-weight: 700;
			}

			.sidebar .subtitle {
				font-size: 0.9rem;
				opacity: 0.9;
				margin-bottom: 2rem;
			}

			.control-section {
				background: rgba(255, 255, 255, 0.15);
				backdrop-filter: blur(10px);
				border-radius: 12px;
				padding: 1.5rem;
				margin-bottom: 1.5rem;
			}

			.control-section h3 {
				font-size: 1rem;
				margin-bottom: 1rem;
				font-weight: 600;
			}

			.control-group {
				margin-bottom: 1rem;
			}

			.control-group:last-child {
				margin-bottom: 0;
			}

			.control-group label {
				display: block;
				font-size: 0.85rem;
				margin-bottom: 0.5rem;
				opacity: 0.95;
			}

			.control-group select,
			.control-group input[type='number'],
			.control-group input[type='text'] {
				width: 100%;
				padding: 0.7rem;
				border: none;
				border-radius: 8px;
				background: rgba(255, 255, 255, 0.2);
				color: white;
				font-size: 0.9rem;
				backdrop-filter: blur(10px);
			}

			.control-group select option {
				background: #667eea;
				color: white;
			}

			.control-group input::placeholder {
				color: rgba(255, 255, 255, 0.7);
			}

			.checkbox-group {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.5rem 0;
			}

			.checkbox-group input[type='checkbox'] {
				width: 18px;
				height: 18px;
				cursor: pointer;
			}

			.btn {
				width: 100%;
				padding: 0.9rem;
				background: rgba(255, 255, 255, 0.25);
				color: white;
				border: 2px solid rgba(255, 255, 255, 0.3);
				border-radius: 8px;
				cursor: pointer;
				font-size: 1rem;
				font-weight: 600;
				transition: all 0.3s;
				backdrop-filter: blur(10px);
				margin-bottom: 1rem;
			}

			.btn:hover {
				background: rgba(255, 255, 255, 0.35);
				border-color: rgba(255, 255, 255, 0.5);
				transform: translateY(-2px);
			}

			.btn:active {
				transform: translateY(0);
			}

			.btn-route {
				background: rgba(46, 204, 113, 0.3);
				border-color: rgba(46, 204, 113, 0.5);
			}

			.btn-route:hover {
				background: rgba(46, 204, 113, 0.4);
			}

			.stats-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1rem;
				margin-top: 1rem;
			}

			.stat-card {
				background: rgba(255, 255, 255, 0.15);
				backdrop-filter: blur(10px);
				border-radius: 10px;
				padding: 1rem;
				text-align: center;
			}

			.stat-value {
				font-size: 2rem;
				font-weight: 700;
				margin-bottom: 0.3rem;
			}

			.stat-label {
				font-size: 0.8rem;
				opacity: 0.9;
			}

			/* –ö–∞—Ä—Ç–∞ */
			.map-container {
				flex: 1;
				position: relative;
				background: #e0e0e0;
			}

			#map {
				width: 100%;
				height: 100%;
			}

			/* –õ–µ–≥–µ–Ω–¥–∞ */
			.legend {
				position: absolute;
				bottom: 20px;
				right: 20px;
				background: white;
				padding: 1.2rem;
				border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
				z-index: 1000;
				min-width: 220px;
			}

			.legend h3 {
				margin-bottom: 1rem;
				font-size: 1rem;
				color: #333;
				font-weight: 600;
			}

			.legend-item {
				display: flex;
				align-items: center;
				gap: 0.8rem;
				margin: 0.5rem 0;
			}

			.legend-color {
				width: 24px;
				height: 24px;
				border-radius: 6px;
				border: 2px solid rgba(0, 0, 0, 0.1);
				flex-shrink: 0;
			}

			.legend-item span {
				font-size: 0.85rem;
				color: #555;
			}

			/* –ó–∞–≥—Ä—É–∑–∫–∞ */
			.loading {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: white;
				padding: 2rem 3rem;
				border-radius: 16px;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
				z-index: 2000;
				display: none;
				text-align: center;
			}

			.loading.active {
				display: block;
			}

			.loading-spinner {
				border: 4px solid #f3f3f3;
				border-top: 4px solid #667eea;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				animation: spin 1s linear infinite;
				margin: 0 auto 1rem;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.loading-text {
				color: #667eea;
				font-weight: 600;
			}

			/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */
			.info-panel {
				position: absolute;
				top: 20px;
				left: 20px;
				background: white;
				padding: 1rem 1.5rem;
				border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
				z-index: 1000;
				font-size: 0.9rem;
				max-width: 300px;
			}

			.info-panel h4 {
				color: #667eea;
				margin-bottom: 0.5rem;
				font-size: 1rem;
			}

			.info-panel p {
				color: #666;
				line-height: 1.6;
				font-size: 0.85rem;
			}

			.route-info {
				background: rgba(46, 204, 113, 0.1);
				border-left: 3px solid #2ecc71;
				padding: 0.8rem;
				margin-top: 1rem;
				border-radius: 6px;
				font-size: 0.85rem;
			}

			@media (max-width: 768px) {
				.sidebar {
					width: 100%;
					height: auto;
					max-height: 50vh;
				}

				body {
					flex-direction: column;
				}
			}
		</style>
	</head>
	<body>
		<!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
		<div class="sidebar">
			<h1>üöó –ê–Ω–∞–ª–∏–∑ –î–¢–ü</h1>
			<p class="subtitle">–ú–æ—Å–∫–≤–∞ ‚Ä¢ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>

			<div class="control-section">
				<h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤</h3>

				<div class="control-group">
					<label>–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞</label>
					<select id="period">
						<option value="all" selected>–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
						<option value="7d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
						<option value="30d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
						<option value="90d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
						<option value="365d">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
					</select>
				</div>

				<div class="control-group">
					<label>–ü–æ—Ä–æ–≥ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–º–∏–Ω. –î–¢–ü –≤ –∑–æ–Ω–µ)</label>
					<input type="number" id="threshold" value="5" min="1" max="50" />
				</div>

				<div class="control-group">
					<label>–†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ —Å–µ—Ç–∫–∏ (–º–µ—Ç—Ä—ã)</label>
					<input
						type="number"
						id="gridSize"
						value="1000"
						min="50"
						max="2000"
						step="50"
					/>
					<small
						style="
							color: #999;
							font-size: 0.75rem;
							display: block;
							margin-top: 0.3rem;
						"
					>
						–ú–µ–Ω—å—à–µ = –¥–µ—Ç–∞–ª—å–Ω–µ–µ, –Ω–æ –±–æ–ª—å—à–µ –∑–æ–Ω. –ë–æ–ª—å—à–µ = –∫—Ä—É–ø–Ω–µ–µ –∑–æ–Ω—ã
					</small>
				</div>
			</div>

			<div class="control-section">
				<h3>üó∫Ô∏è –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
				<p style="font-size: 0.85rem; color: #666; margin-bottom: 0.8rem;">
					–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ (–ø–æ—è–≤–∏—Ç—Å—è –≤–≤–µ—Ä—Ö—É) –∏–ª–∏ –ø–æ–ª—è –Ω–∏–∂–µ:
				</p>

				<div class="control-group">
					<label>–û—Ç–∫—É–¥–∞ (–∞–¥—Ä–µ—Å –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)</label>
					<input
						type="text"
						id="routeFrom"
						placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å"
					/>
				</div>

				<div class="control-group">
					<label>–ö—É–¥–∞ (–∞–¥—Ä–µ—Å –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)</label>
					<input
						type="text"
						id="routeTo"
						placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –í–î–ù–•"
					/>
				</div>

				<button class="btn btn-route" onclick="buildRoute()">
					üìç –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
				</button>
				<button
					class="btn"
					onclick="clearRoute()"
					style="
						background: rgba(231, 76, 60, 0.3);
						border-color: rgba(231, 76, 60, 0.5);
					"
				>
					üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
				</button>

				<div id="routeInfo" class="route-info" style="display: none">
					<strong>–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω</strong>
					<div id="routeDetails"></div>
				</div>
			</div>

			<div class="control-section">
				<h3>üëÅÔ∏è –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>

				<div class="checkbox-group">
					<input type="checkbox" id="showAccidents" />
					<label for="showAccidents"
						>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ –î–¢–ü (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label
					>
				</div>

				<div
					style="
						margin-top: 0.8rem;
						padding: 0.8rem;
						background: #f0f4ff;
						border-radius: 8px;
						font-size: 0.85rem;
						color: #555;
					"
				>
					üí° <strong>–°–æ–≤–µ—Ç:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –æ–ø–∞—Å–Ω—É—é –∑–æ–Ω—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –î–¢–ü
					–≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë
				</div>
			</div>

			<button class="btn" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
			<button class="btn" onclick="resetCache()" style="background: rgba(231, 76, 60, 0.3); border-color: rgba(231, 76, 60, 0.5); margin-top: 0.5rem;">
				üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –¥–∞–Ω–Ω—ã—Ö
			</button>

			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-value" id="accidentsCount">0</div>
					<div class="stat-label">–î–¢–ü</div>
				</div>
				<div class="stat-card">
					<div class="stat-value" id="hotspotsCount">0</div>
					<div class="stat-label">–û–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω</div>
				</div>
			</div>
		</div>

		<!-- –ö–∞—Ä—Ç–∞ -->
		<div class="map-container">
			<div id="map"></div>

			<div class="loading" id="loading">
				<div class="loading-spinner"></div>
				<div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
			</div>

			<div class="info-panel">
				<h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
				<p>
					–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫
					–∞–¥—Ä–µ—Å–æ–≤.
				</p>
			</div>

			<div class="legend">
				<h3>üé® –£—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
				<div class="legend-item">
					<div class="legend-color" style="background: #f39c12"></div>
					<span><strong>–°—Ä–µ–¥–Ω–∏–π</strong> (0.2-0.3 –Ω–∞ 1000 –º¬≤)</span>
				</div>
				<div class="legend-item">
					<div class="legend-color" style="background: #e74c3c"></div>
					<span><strong>–í—ã—Å–æ–∫–∏–π</strong> (‚â• 0.3 –Ω–∞ 1000 –º¬≤)</span>
				</div>
				<div style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid #eee; font-size: 0.75rem; color: #999;">
					üìê –í—Å–µ –∑–æ–Ω—ã –∏–º–µ—é—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–¥–∏—É—Å 1000–º<br>
					üìä –ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ø–ª–æ—â–∞–¥–∏ 0.1 –∫–º¬≤
				</div>
				<div
					style="
						margin-top: 0.8rem;
						padding-top: 0.8rem;
						border-top: 1px solid #eee;
						font-size: 0.75rem;
						color: #999;
					"
				>
					üî¥ –ö—Ä–∞—Å–Ω—ã–µ —Ç–æ—á–∫–∏ = –æ—Ç–¥–µ–ª—å–Ω—ã–µ –î–¢–ü
				</div>
			</div>
		</div>

		<!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API -->
		<script src="https://api-maps.yandex.ru/2.1/?apikey=8a08b8a3-085d-4758-8055-6078a03bf83f&lang=ru_RU"></script>

		<script>
			// ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ '–í–ê–®_API_–ö–õ–Æ–ß' –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π API –∫–ª—é—á –∏–∑ –Ø–Ω–¥–µ–∫—Å.–ö–∞–±–∏–Ω–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞!
			// –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á: https://developer.tech.yandex.ru/

			let map, hotspotsCollection, routeMultiRoute, clusterer
			let accidentsData = []
			let hotspotsData = []
			let hotspotsLoaded = false // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω (–∑–∞–≥—Ä—É–∂–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑)
			let selectedZone = null // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∑–æ–Ω–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –î–¢–ü
			let isLoading = false // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ (–±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã)

			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
			ymaps.ready(function () {
				// –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
				const apiKey = document
					.querySelector('script[src*="api-maps.yandex.ru"]')
					?.src.match(/apikey=([^&\s]+)/)?.[1]
				
				if (!apiKey || apiKey === '–í–ê–®_API_–ö–õ–Æ–ß') {
					console.warn(
						'‚ö†Ô∏è API –∫–ª—é—á –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –ó–∞–º–µ–Ω–∏—Ç–µ –í–ê–®_API_–ö–õ–Æ–ß –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –≤ —Å—Ç—Ä–æ–∫–µ 491 index.html'
					)
					alert(
						'‚ö†Ô∏è API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!\n\n–ó–∞–º–µ–Ω–∏—Ç–µ –í–ê–®_API_–ö–õ–Æ–ß –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:\nhttps://developer.tech.yandex.ru/\n\n–ë–µ–∑ –∫–ª—é—á–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.'
					)
				} else {
					console.log('‚úÖ API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω:', apiKey.substring(0, 8) + '...')
				}

				// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
				try {
					map = new ymaps.Map('map', {
						center: [55.7558, 37.6173], // –ú–æ—Å–∫–≤–∞
						zoom: 11,
						controls: ['zoomControl', 'fullscreenControl', 'geolocationControl', 'routePanelControl'],
					})

					// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–∞—Ä—Ç—ã
					map.events.add('error', function (e) {
						console.error('‚ùå –û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', e)
						const errorMessage = e.get('errorMessage') || ''
						if (errorMessage.includes('Invalid API key') || errorMessage.includes('API key')) {
							alert(
								'‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º!\n\n' +
								'–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:\n' +
								'1. –ö–ª—é—á –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ –∫–∞–±–∏–Ω–µ—Ç–µ (–∞–∫—Ç–∏–≤–∞—Ü–∏—è –¥–æ 15 –º–∏–Ω—É—Ç)\n' +
								'2. –î–æ–º–µ–Ω localhost –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã\n' +
								'3. –í–∫–ª—é—á–µ–Ω—ã —Å–µ—Ä–≤–∏—Å—ã: JavaScript API, –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è, –ì–µ–æ–∫–æ–¥–µ—Ä\n\n' +
								'–ö–∞–±–∏–Ω–µ—Ç: https://developer.tech.yandex.ru/'
							)
						}
					})

					// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–Ω–µ–ª–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
					try {
						const routePanelControl = map.controls.get('routePanelControl')
						if (routePanelControl && routePanelControl.routePanel) {
							routePanelControl.routePanel.state.set({
								from: '', // –Ω–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
								to: '',   // –∫–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞
								type: 'auto' // —Ç–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞: auto (–∞–≤—Ç–æ), masstransit (—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç), pedestrian (–ø–µ—à–∫–æ–º)
							})
							console.log('‚úÖ –ü–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞')
						} else {
							console.warn('‚ö†Ô∏è routePanelControl –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é buildRoute()')
						}
					} catch (error) {
						console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å routePanelControl:', error.message)
						console.info('üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é buildRoute() –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ —á–µ—Ä–µ–∑ MultiRoute API')
					}

					// –ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω
					hotspotsCollection = new ymaps.GeoObjectCollection()
					
					// –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Ç–æ—á–µ–∫ –î–¢–ü
					clusterer = new ymaps.Clusterer({
						preset: 'islands#invertedVioletClusterIcons',
						groupByCoordinates: false,
						clusterDisableClickZoom: true,
						clusterHideIconOnBalloonOpen: false,
						geoObjectHideIconOnBalloonOpen: false,
						clusterBalloonContentLayout: 'cluster#balloonCarousel',
						clusterBalloonItemContentLayout: 'cluster#balloonCarouselItem',
						clusterBalloonPanelContentLayout: 'cluster#balloonCarousel',
						clusterOpenBalloonOnClick: true,
					})

					map.geoObjects.add(hotspotsCollection)
					map.geoObjects.add(clusterer)

					// –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–æ–Ω—ã –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
					loadHotspotsOnce()

					// –ó–∞–≥—Ä—É–∑–∫–∞ –î–¢–ü —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∑—É–º–µ (zoom >= 13) –∏–ª–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–æ–Ω—É
					let loadTimeout = null
					const debouncedLoadAccidents = function () {
						if (isLoading) return // –ë–ª–æ–∫–∏—Ä—É–µ–º, –µ—Å–ª–∏ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞
						
						const zoom = map.getZoom()
						const showAccidents = document.getElementById('showAccidents').checked
						
						// –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∑–æ–Ω–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –î–¢–ü –¥–ª—è –Ω–µ—ë –ø—Ä–∏ –∑—É–º–µ
						if (selectedZone) {
							if (loadTimeout) {
								clearTimeout(loadTimeout)
							}
							loadTimeout = setTimeout(() => {
								loadAccidentsForZone(selectedZone)
							}, 300)
							return
						}
						
						// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∑—É–º–µ (>= 13) –∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º —á–µ–∫–±–æ–∫—Å–µ
						if (showAccidents && zoom >= 13) {
							if (loadTimeout) {
								clearTimeout(loadTimeout)
							}
							loadTimeout = setTimeout(() => {
								loadAccidents()
							}, 500)
						} else {
							// –û—á–∏—â–∞–µ–º —Ç–æ—á–∫–∏ –ø—Ä–∏ –º–∞–ª–µ–Ω—å–∫–æ–º –∑—É–º–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã
							if (!selectedZone) {
								clusterer.removeAll()
								document.getElementById('accidentsCount').textContent = '0'
							}
						}
					}

					map.events.add('boundschange', debouncedLoadAccidents)
					map.events.add('zoomchange', debouncedLoadAccidents)
				} catch (error) {
					console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error)
					alert(
						'‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É!\n\n' +
						'–û—à–∏–±–∫–∞: ' + error.message + '\n\n' +
						'–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n' +
						'1. API –∫–ª—é—á –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω\n' +
						'2. –î–æ–º–µ–Ω localhost –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ\n' +
						'3. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π'
					)
					return
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–æ–Ω—ã
				document
					.getElementById('period')
					.addEventListener('change', function () {
						hotspotsLoaded = false
						loadHotspotsOnce()
					})

				document
					.getElementById('threshold')
					.addEventListener('change', function () {
						hotspotsLoaded = false
						loadHotspotsOnce()
					})

				document
					.getElementById('gridSize')
					.addEventListener('change', function () {
						hotspotsLoaded = false
						loadHotspotsOnce()
					})
			})

			// –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
			async function loadHotspotsOnce() {
				if (hotspotsLoaded || isLoading) {
					console.log('‚ö†Ô∏è –ó–æ–Ω—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º')
					return
				}

				// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
				if (!map || !hotspotsCollection) {
					console.warn('‚ö†Ô∏è –ö–∞—Ä—Ç–∞ –∏–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∂–¥–µ–º...')
					setTimeout(loadHotspotsOnce, 500)
					return
				}

				isLoading = true
				const loading = document.getElementById('loading')
				if (loading) {
					loading.classList.add('active')
					loading.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω...'
				}

				try {
					// –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–æ–Ω—ã –¥–ª—è –≤—Å–µ–π –ú–æ—Å–∫–≤—ã (–±–æ–ª—å—à–æ–π bbox)
					const bbox = '37.0,55.5,38.0,56.0' // –í–µ—Å—å —Ä–µ–≥–∏–æ–Ω –ú–æ—Å–∫–≤—ã
					const period = document.getElementById('period').value
					const threshold = document.getElementById('threshold').value
					const gridSize = document.getElementById('gridSize').value

					const requestStartTime = performance.now()
					console.log('üì° –ó–∞–ø—Ä–æ—Å –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω:', { bbox, period, threshold, gridSize })

					const response = await fetch(
						`api/hotspots.php?bbox=${encodeURIComponent(bbox)}&period=${period}&threshold=${threshold}&grid=${gridSize}`
					)
					
					// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ JSON
					const contentType = response.headers.get('content-type')
					if (!contentType || !contentType.includes('application/json')) {
						const errorText = await response.text()
						console.error('‚ùå –û—Ç–≤–µ—Ç –Ω–µ JSON:', errorText.substring(0, 500))
						throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON. HTTP ${response.status}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ PHP.`)
					}
					
					if (!response.ok) {
						const errorData = await response.json().catch(() => ({ error: 'Unknown error' }))
						throw new Error(`HTTP ${response.status}: ${errorData.error || 'Unknown error'}`)
					}

					const data = await response.json()
					const features = data.features || []
					const requestTime = ((performance.now() - requestStartTime) / 1000).toFixed(2)
					const cacheStatus = response.headers.get('X-Cache') || 'UNKNOWN'

					console.log(
						'‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω:',
						features.length,
						features.length > 0 ? '(–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞)' : '(–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç)',
						`| –í—Ä–µ–º—è: ${requestTime}—Å | –ö—ç—à: ${cacheStatus}`
					)

					// –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–æ–Ω—ã
					try {
						if (map.geoObjects && hotspotsCollection) {
							map.geoObjects.remove(hotspotsCollection)
							hotspotsCollection.removeAll()
						}
					} catch (e) {
						console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ç–∞—Ä—ã—Ö –∑–æ–Ω:', e)
					}

					if (features.length > 0) {
						let circlesCreated = 0
						features.forEach(feature => {
							try {
								const coords = feature.geometry?.coordinates
								const props = feature.properties || {}
								
								if (!coords || coords.length < 2) {
									console.warn('‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–æ–Ω–∞ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:', feature)
									return
								}

								const center = [coords[1], coords[0]] // [lat, lon] –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
								const radius = props.radius || 125 // —Ä–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö

								const colors = {
									medium: '#f39c12',  // –û—Ä–∞–Ω–∂–µ–≤—ã–π - —Å—Ä–µ–¥–Ω—è—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å
									high: '#e74c3c',    // –ö—Ä–∞—Å–Ω—ã–π - –≤—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å
								}

								const riskLevel = props.risk_level || 'medium'
								
								// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–æ–Ω—ã —Å –Ω–∏–∑–∫–∏–º —É—Ä–æ–≤–Ω–µ–º (–Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞—Å—Ç—å —Å—é–¥–∞, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
								if (riskLevel === 'low') {
									return
								}
								const count = props.count || 0

								// –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥–ª—É—é –∑–æ–Ω—É
								const circle = new ymaps.Circle(
									[center, radius], // [—Ü–µ–Ω—Ç—Ä, —Ä–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö]
									{
										balloonContentHeader: '–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞',
										balloonContentBody: `
										<strong>–î–¢–ü:</strong> ${count}<br>
										<strong>–¢—è–∂–µ–ª—ã—Ö:</strong> ${props.severe_count || 0}<br>
										<strong>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å:</strong> ${props.density_per_1000m2 ? props.density_per_1000m2.toFixed(4) : 'N/A'} –Ω–∞ 1000 –º¬≤<br>
										<strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${riskLevel}<br>
										<br>
										<em>–ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –î–¢–ü –≤ —ç—Ç–æ–π –∑–æ–Ω–µ</em>
									`,
										hintContent: `–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞: ${count} –î–¢–ü`,
									},
									{
										fillColor: colors[riskLevel] || '#95a5a6',
										fillOpacity: riskLevel === 'low' ? 0.5 : 0.3,
										strokeColor: '#fff',
										strokeWidth: 2,
										strokeOpacity: 0.8,
									}
								)

								// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∑–æ–Ω—É
								circle.events.add('click', function (e) {
									e.stopPropagation() // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
									loadAccidentsForZone(props)
								})

								hotspotsCollection.add(circle)
								circlesCreated++
							} catch (e) {
								console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫—Ä—É–≥–∞:', e, feature)
							}
						})

						console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ –∫—Ä—É–≥–æ–≤: ${circlesCreated} –∏–∑ ${features.length}`)

						// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç—É
						if (circlesCreated > 0) {
							map.geoObjects.add(hotspotsCollection)
							console.log('‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è –∑–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ –∫–∞—Ä—Ç—É')
						}

						hotspotsLoaded = true
						const countEl = document.getElementById('hotspotsCount')
						if (countEl) {
							countEl.textContent = circlesCreated
						}
					} else {
						console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–æ–Ω–∞—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è')
						const countEl = document.getElementById('hotspotsCount')
						if (countEl) {
							countEl.textContent = '0'
						}
					}
				} catch (error) {
					console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω:', error)
					alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω: ' + error.message)
				} finally {
					isLoading = false
					if (loading) {
						loading.classList.remove('active')
						loading.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...'
					}
				}
			}

			// –ó–∞–≥—Ä—É–∑–∫–∞ –î–¢–ü –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã
			async function loadAccidentsForZone(zoneProps) {
				if (isLoading) {
					console.log('‚ö†Ô∏è –£–∂–µ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º')
					return
				}
				
				// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–æ–Ω—É
				selectedZone = zoneProps
				
				isLoading = true
				const loading = document.getElementById('loading')
				if (loading) {
					loading.classList.add('active')
					loading.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –î–¢–ü –≤ –∑–æ–Ω–µ...'
				}

				try {
					// –ò—Å–ø–æ–ª—å–∑—É–µ–º bbox –∑–æ–Ω—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –î–¢–ü
					const bbox = zoneProps.bbox
					const bboxStr = `${bbox.minLon},${bbox.minLat},${bbox.maxLon},${bbox.maxLat}`

					const response = await fetch(
						`api/accidents.php?bbox=${encodeURIComponent(bboxStr)}&limit=1000`
					)
					if (!response.ok) throw new Error(`HTTP ${response.status}`)

					const data = await response.json()
					const features = data.features || []

					console.log('‚úÖ –î–¢–ü –≤ –∑–æ–Ω–µ:', features.length)

					// –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
					clusterer.removeAll()

					if (features.length > 0) {
						const placemarks = []
						
						features.forEach(feature => {
							const coords = feature.geometry.coordinates
							const props = feature.properties

							const placemark = new ymaps.Placemark(
								[coords[1], coords[0]],
								{
									balloonContentHeader: '–î–¢–ü',
									balloonContentBody: `
                                    <strong>–î–∞—Ç–∞:</strong> ${props.dt || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}<br>
                                    <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${props.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}<br>
                                    <strong>–¢—è–∂–µ—Å—Ç—å:</strong> ${props.severity || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}<br>
                                    <strong>–ê–¥—Ä–µ—Å:</strong> ${props.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                `,
								},
								{
									preset: 'islands#redCircleDotIcon',
									iconColor: '#e74c3c',
								}
							)

							placemarks.push(placemark)
						})

						// –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä
						clusterer.add(placemarks)
						document.getElementById('accidentsCount').textContent = features.length
					} else {
						document.getElementById('accidentsCount').textContent = '0'
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –î–¢–ü –¥–ª—è –∑–æ–Ω—ã:', error)
					alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –î–¢–ü: ' + error.message)
				} finally {
					isLoading = false
					if (loading) {
						loading.classList.remove('active')
						loading.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...'
					}
				}
			}

			// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –î–¢–ü (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∑—É–º–µ >= 13)
			async function loadAccidents() {
				if (!map || isLoading) return

				const showAccidents = document.getElementById('showAccidents').checked
				const zoom = map.getZoom()
				
				if (!showAccidents || zoom < 13) {
					clusterer.removeAll()
					document.getElementById('accidentsCount').textContent = '0'
					return
				}

				isLoading = true
				const loading = document.getElementById('loading')
				if (loading) {
					loading.classList.add('active')
					loading.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –î–¢–ü...'
				}

				const bounds = map.getBounds()
				const bbox = `${bounds[0][1]},${bounds[0][0]},${bounds[1][1]},${bounds[1][0]}`
				const maxPoints = zoom < 14 ? 1000 : 2000

				try {
					const response = await fetch(
						`api/accidents.php?bbox=${encodeURIComponent(bbox)}&limit=${maxPoints}`
					)
					if (!response.ok) throw new Error(`HTTP ${response.status}`)

					const data = await response.json()
					const features = data.features || []

					console.log('‚úÖ –î–¢–ü –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', features.length)

					clusterer.removeAll()

					if (features.length > 0) {
						const placemarks = []
						
						features.forEach(feature => {
							const coords = feature.geometry.coordinates
							const props = feature.properties

							const placemark = new ymaps.Placemark(
								[coords[1], coords[0]],
								{
									balloonContentHeader: '–î–¢–ü',
									balloonContentBody: `
                                    <strong>–î–∞—Ç–∞:</strong> ${props.dt || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}<br>
                                    <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${props.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}<br>
                                    <strong>–¢—è–∂–µ—Å—Ç—å:</strong> ${props.severity || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}<br>
                                    <strong>–ê–¥—Ä–µ—Å:</strong> ${props.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                `,
								},
								{
									preset: 'islands#redCircleDotIcon',
									iconColor: '#e74c3c',
								}
							)

							placemarks.push(placemark)
						})

						// –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä
						clusterer.add(placemarks)
						document.getElementById('accidentsCount').textContent = features.length
					} else {
						document.getElementById('accidentsCount').textContent = '0'
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –î–¢–ü:', error)
					alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –î–¢–ü: ' + error.message)
				} finally {
					isLoading = false
					if (loading) {
						loading.classList.remove('active')
						loading.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...'
					}
				}
			}

			// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
			function loadData() {
				if (isLoading) {
					console.log('‚ö†Ô∏è –£–∂–µ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º')
					return
				}
				hotspotsLoaded = false
				selectedZone = null // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–æ–Ω—É
				clusterer.removeAll()
				document.getElementById('accidentsCount').textContent = '0'
				loadHotspotsOnce()
			}

			// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞ –¥–∞–Ω–Ω—ã—Ö
			async function resetCache() {
				if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –¥–∞–Ω–Ω—ã—Ö? –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞.')) {
					return
				}
				
				try {
					// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —á–µ—Ä–µ–∑ API
					const response = await fetch('api/hotspots.php?bbox=37.0,55.5,38.0,56.0&period=all&threshold=5&grid=1000&reset_cache=1')
					if (!response.ok) throw new Error(`HTTP ${response.status}`)
					
					console.log('‚úÖ –ö—ç—à —Å–±—Ä–æ—à–µ–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...')
					hotspotsLoaded = false
					loadHotspotsOnce()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞:', error)
					alert('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞: ' + error.message)
				}
			}

			// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ MultiRoute API (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
			async function buildRoute() {
				const from = document.getElementById('routeFrom').value.trim()
				const to = document.getElementById('routeTo').value.trim()

				if (!from || !to) {
					alert('–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫–∏ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∞')
					return
				}

				// –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
				if (routeMultiRoute) {
					map.geoObjects.remove(routeMultiRoute)
					routeMultiRoute = null
				}

				const loading = document.getElementById('loading')
				loading.classList.add('active')

				try {
					// –°–æ–∑–¥–∞–µ–º –º—É–ª—å—Ç–∏–º–∞—Ä—à—Ä—É—Ç —á–µ—Ä–µ–∑ MultiRoute API
					routeMultiRoute = new ymaps.multiRouter.MultiRoute(
						{
							referencePoints: [from, to],
							params: {
								routingMode: 'auto' // 'auto', 'masstransit', 'pedestrian'
							}
						},
						{
							boundsAutoApply: true,
							// –í–∏–∑—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
							routeActiveStrokeWidth: 4,
							routeActiveStrokeColor: '#0088ff',
							routeStrokeWidth: 3,
							routeStrokeColor: '#666666'
						}
					)

					map.geoObjects.add(routeMultiRoute)

					// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
					routeMultiRoute.model.events.add('requestsuccess', function () {
						const activeRoute = routeMultiRoute.getActiveRoute()
						if (activeRoute) {
							const distance = activeRoute.properties.get('distance')
							const duration = activeRoute.properties.get('duration')

							if (distance && duration) {
								const distanceKm = (distance.value / 1000).toFixed(2)
								const durationMin = Math.round(duration.value / 60)

								document.getElementById('routeDetails').innerHTML = `
									<div style="margin-top: 0.5rem;">
										<div>üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceKm} –∫–º</div>
										<div>‚è±Ô∏è –í—Ä–µ–º—è: ${durationMin} –º–∏–Ω</div>
									</div>
								`
								document.getElementById('routeInfo').style.display = 'block'
							}
						}
						loading.classList.remove('active')
					})

					// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
					routeMultiRoute.model.events.add('requestfail', function () {
						alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∞–¥—Ä–µ—Å–æ–≤\n2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞\n3. –ß—Ç–æ –¥–æ–º–µ–Ω localhost –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã')
						loading.classList.remove('active')
					})

				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error)
					alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞: ' + error.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.')
					loading.classList.remove('active')
				}
			}

			// –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞
			function clearRoute() {
				// –û—á–∏—â–∞–µ–º MultiRoute
				if (routeMultiRoute) {
					map.geoObjects.remove(routeMultiRoute)
					routeMultiRoute = null
				}

				// –û—á–∏—â–∞–µ–º –ø–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
				try {
					const routePanelControl = map.controls.get('routePanelControl')
					if (routePanelControl) {
						routePanelControl.routePanel.state.set({
							from: '',
							to: '',
							type: 'auto'
						})
					}
				} catch (error) {
					// –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
				}

				document.getElementById('routeFrom').value = ''
				document.getElementById('routeTo').value = ''
				document.getElementById('routeInfo').style.display = 'none'
			}
		</script>
	</body>
</html>
